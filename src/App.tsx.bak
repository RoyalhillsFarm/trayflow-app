// src/App.tsx
import {
  BrowserRouter,
  Routes,
  Route,
  NavLink,
  useLocation,
  useNavigate,
  useParams,
} from "react-router-dom";
import {
  useEffect,
  useMemo,
  useState,
  FormEvent,
  type CSSProperties,
} from "react";
import "./App.css";

import trayflowLogo from "./assets/trayflow-logo.png";
import trayflowIcon from "./assets/trayflow-icon.png";

import { formatDisplayDate } from "./utils/formatDate";
import { supabase } from "./utils/supabaseClient";
import Varieties from "./pages/Varieties";
import type { Variety } from "./lib/storage";
import CustomersPage from "./pages/CustomersPage";
import TasksPage from "./pages/TasksPage";
import NewTaskPage from "./pages/NewTaskPage";
import LoginPage from "./pages/LoginPage";

import {
  getTasks as getTasksSB,
  addTask as addTaskSB,
  getCustomers as getCustomersSB,
  addCustomer as addCustomerSB,
  updateCustomer as updateCustomerSB,
  getOrders as getOrdersSB,
  addOrder as addOrderSB,
  getEvents as getEventsSB,
  type Task,
  type Customer,
  type Order,
  type OrderStatus,
  type Event,
} from "./lib/supabaseStorage";

/* ----------------- DATE HELPERS ----------------- */

function toYMD(d: Date): string {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function addDaysYMD(ymd: string, days: number): string {
  const d = new Date(ymd + "T00:00:00");
  d.setDate(d.getDate() + days);
  return toYMD(d);
}

function subtractDaysYMD(ymd: string, days: number): string {
  return addDaysYMD(ymd, -days);
}

const DOWS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] as const;
type DOW = (typeof DOWS)[number];

function ymdToDow(ymd: string): DOW {
  const d = new Date(ymd + "T00:00:00");
  return DOWS[d.getDay()];
}

function listDates(startYmd: string, days: number): string[] {
  return Array.from({ length: days }, (_, i) => addDaysYMD(startYmd, i));
}

function dayLabel(ymd: string) {
  return `${formatDisplayDate(ymd)} (${ymdToDow(ymd)})`;
}

function parseCreatedAtToMs(created_at?: string | null): number {
  if (!created_at) return 0;
  const ms = Date.parse(created_at);
  return Number.isFinite(ms) ? ms : 0;
}

/* ----------------- ORDER GROUPING (NO DB CHANGES) ----------------- */
/**
 * We don't have order_group_id/order_number columns.
 * So we group "real orders" using:
 * - same customerId
 * - same deliveryDate
 * - created_at in the same 5-minute bucket
 *
 * This matches the farmer workflow: you add multiple lines, hit Save once,
 * and those rows get created together.
 */
const GROUP_BUCKET_MINUTES = 5;

function groupKeyForLine(o: Order): string {
  const ms = parseCreatedAtToMs((o as any).created_at);
  const bucket = ms
    ? Math.floor(ms / (GROUP_BUCKET_MINUTES * 60 * 1000))
    : 0;
  return `${o.customerId}__${o.deliveryDate}__${bucket}`;
}

function stableShortHash(str: string): string {
  // tiny deterministic hash -> base36
  let h = 2166136261;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  const x = (h >>> 0).toString(36).toUpperCase();
  return x.slice(0, 6).padStart(6, "0");
}

function displayOrderNumber(groupKey: string): string {
  return `TF-${stableShortHash(groupKey)}`;
}

type OrderGroup = {
  key: string;
  customerId: string;
  deliveryDate: string; // canonical delivery date (assumed same across lines)
  status: OrderStatus;
  createdAtMs: number;
  lines: Order[];
};

/* ----------------- LAYOUT ----------------- */

function Sidebar() {
  return (
    <aside className="sidebar">
      <div className="sidebar-logo-block">
        <img
          src={trayflowLogo}
          alt="TrayFlow Logo"
          className="sidebar-logo-image"
        />
        <div className="sidebar-logo-text">
          <div className="sidebar-subtitle">MICROGREENS PRODUCTION PLANNER</div>
        </div>
      </div>

      <nav className="sidebar-nav">
        <SidebarLink to="/" label="Dashboard" />
        <SidebarLink to="/orders" label="Orders" />
        <SidebarLink to="/tasks" label="Tasks" />
        <SidebarLink to="/calendar" label="Calendar" />
        <SidebarLink to="/varieties" label="Varieties" />
        <SidebarLink to="/customers" label="Customers" />
        <SidebarLink to="/production-sheet" label="Production Sheet" />
        <SidebarLink to="/settings" label="Settings" />
      </nav>

      <div className="sidebar-footer">
        <div>TrayFlow v1.0.0</div>
        <div>© {new Date().getFullYear()} TrayFlow</div>
      </div>
    </aside>
  );
}

function SidebarLink({ to, label }: { to: string; label: string }) {
  return (
    <NavLink
      to={to}
      end={to === "/"}
      className={({ isActive }) =>
        [
          "sidebar-link",
          isActive ? "sidebar-link-active" : "sidebar-link-inactive",
        ].join(" ")
      }
    >
      <span>{label}</span>
    </NavLink>
  );
}

function TopBar() {
  const location = useLocation();
  const navigate = useNavigate();
  const showNewTaskButton = location.pathname === "/tasks";

  const [email, setEmail] = useState<string | null>(null);

  useEffect(() => {
  // Set initial auth state
  supabase.auth.getUser().then(({ data }) => {
    setEmail(data.user?.email ?? null);
  });

  // Listen for login/logout changes
  const { data: authListener } = supabase.auth.onAuthStateChange(
    (_event, session) => {
      setEmail(session?.user?.email ?? null);
    }
  );

  return () => {
    authListener.subscription.unsubscribe();
  };
}, []);

  return (
    <header className="topbar">
      <div className="topbar-center">
        <img
          src={trayflowIcon}
          alt="TrayFlow Icon"
          className="topbar-logo-image"
        />
        <span className="topbar-title">TRAYFLOW</span>
      </div>

      <div className="topbar-right">
        {showNewTaskButton && (
          <button
            className="topbar-button"
            onClick={() => navigate("/tasks/new")}
          >
            New Task
          </button>
        )}

        {email ? (
  <>
    <span
      style={{
        fontSize: 12,
        opacity: 0.6,
        marginRight: 8,
      }}
    >
      {email}
    </span>

    <button
      className="topbar-button"
      onClick={async () => {
        await supabase.auth.signOut();
        window.location.reload();
      }}
    >
      Logout
    </button>
  </>
) : (
  <button
    className="topbar-button"
    onClick={() => navigate("/login")}
  >
    Login
  </button>
   )}
      </div>
    </header>
  );
}

/* ----------------- PAGES ----------------- */

function DashboardPage() {
  return (
    <div className="page">
      <h1 className="page-title">Dashboard</h1>
      <p className="page-text">
        This is your TrayFlow dashboard. We’ll add Farm Overview, Seed Demo Data,
        and more next.
      </p>
    </div>
  );
}

/* ----- Helpers: fetch Varieties from Supabase for Orders dropdown ----- */
async function fetchVarietiesForOrders(): Promise<Variety[]> {
  const { data, error } = await supabase
    .from("varieties")
    .select("id, variety, harvest_days")
    .order("variety", { ascending: true });

  if (error) throw new Error(error.message);

  return (data ?? []).map((r: any) => ({
    id: r.id,
    name: r.variety ?? "",
    daysToHarvest: Number(r.harvest_days ?? 0),
  }));
}

/* ----------------- ORDERS (Grouped) ----------------- */

function buildOrderGroups(orders: Order[]): OrderGroup[] {
  const map = new Map<string, OrderGroup>();

  for (const o of orders) {
    const k = groupKeyForLine(o);
    const ms = parseCreatedAtToMs((o as any).created_at);

    const existing = map.get(k);
    if (!existing) {
      map.set(k, {
        key: k,
        customerId: o.customerId,
        deliveryDate: o.deliveryDate,
        status: o.status,
        createdAtMs: ms,
        lines: [o],
      });
    } else {
      existing.lines.push(o);
      existing.createdAtMs = Math.min(
        existing.createdAtMs || ms,
        ms || existing.createdAtMs
      );
      // Status: if any line is draft -> draft; else if any confirmed -> confirmed; else delivered
      const statuses = new Set(existing.lines.map((x) => x.status));
      existing.status = statuses.has("draft")
        ? "draft"
        : statuses.has("confirmed")
        ? "confirmed"
        : "delivered";
    }
  }

  const groups = Array.from(map.values());

  // Normalize lines order (stable)
  for (const g of groups) {
    g.lines.sort((a, b) => {
      const am = parseCreatedAtToMs((a as any).created_at);
      const bm = parseCreatedAtToMs((b as any).created_at);
      if (am !== bm) return am - bm;
      return a.id.localeCompare(b.id);
    });
  }

  // Sort groups: newest delivery first, then newest created
  groups.sort((a, b) => {
    const d = b.deliveryDate.localeCompare(a.deliveryDate);
    if (d !== 0) return d;
    return (b.createdAtMs || 0) - (a.createdAtMs || 0);
  });

  return groups;
}
type DoNowPillProps = {
  label: string;
  count: number;
  unit: string;
  isActive: boolean;
  variant?: "default" | "error";
  onClick: () => void;
};

function DoNowPill({
  label,
  count,
  unit,
  isActive,
  variant = "default",
  onClick,
}: DoNowPillProps) {
  const backgroundColor = isActive
    ? variant === "error"
      ? "#fee2e2"
      : "#e0f2fe"
    : variant === "error" && count > 0
    ? "#ffebee"
    : "#f1f5f9";

  const textColor = isActive
    ? variant === "error"
      ? "#b91c1c"
      : "#0369a1"
    : variant === "error" && count > 0
    ? "#dc2626"
    : "#0f172a";

  return (
    <button
      onClick={onClick}
      style={{
        display: "flex",
        flexDirection: "column",
        alignItems: "flex-start",
        padding: "12px 16px",
        backgroundColor,
        border: "none",
        borderRadius: "12px",
        cursor: "pointer",
        minWidth: "140px",
        textAlign: "left",
        boxShadow: isActive ? "0 1px 3px rgba(0,0,0,0.1)" : "none",
        transform: isActive ? "translateY(-2px)" : "none",
      }}
    >
      <span style={{ fontSize: "14px", color: textColor, opacity: 0.9, marginBottom: "4px" }}>
        {label}
      </span>
      <span style={{ fontSize: "24px", fontWeight: 700, color: textColor, lineHeight: 1.2 }}>
        {count}
      </span>
      <span style={{ fontSize: "12px", color: textColor, opacity: 0.8 }}>
        {unit}
      </span>
    </button>
  );
}

function OrdersPage() {
  const navigate = useNavigate();
  const location = useLocation();

  const [orders, setOrders] = useState<Order[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [varieties, setVarieties] = useState<Variety[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // “Do Now” filter
  const [doNowFilter, setDoNowFilter] = useState<
    "none" | "sow" | "harvest" | "deliver" | "overdue"
  >("none");

  const todayYMD = toYMD(new Date());

  const groups = useMemo(() => buildOrderGroups(orders), [orders]);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        setError(null);

        const [os, cs, vs] = await Promise.all([
          getOrdersSB(),
          getCustomersSB(),
          fetchVarietiesForOrders(),
        ]);

        if (!alive) return;

        setOrders(os);
        setCustomers(cs);
        setVarieties(vs);
      } catch (e: any) {
        if (!alive) return;
        setError(e?.message ?? "Failed to load orders.");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [location.key]);

  const customerName = (id: string) =>
    customers.find((c) => c.id === id)?.name ?? "Unknown customer";

  const varietyName = (id: string) =>
    varieties.find((v) => v.id === id)?.name ?? "Unknown variety";

  const varietyGrowDays = (id: string) =>
    Number(varieties.find((v) => v.id === id)?.daysToHarvest ?? 0);

  // ✅ Quick Actions: update status for all orders in the group (by customerId + deliveryDate)
  async function updateGroupStatus(g: OrderGroup, status: OrderStatus) {
    // optimistic update
    setOrders((prev) =>
      prev.map((o) =>
        o.customerId === g.customerId && o.deliveryDate === g.deliveryDate
          ? { ...o, status }
          : o
      )
    );

    // persist to DB
    const groupOrders = orders.filter(
      (o) => o.customerId === g.customerId && o.deliveryDate === g.deliveryDate
    );

    await Promise.all(groupOrders.map((o) => updateOrderStatusSB(o.id, status)));
  }

  const smallBtn: CSSProperties = {
    padding: "8px 12px",
    borderRadius: 999,
    border: "1px solid #e2e8f0",
    background: "#fff",
    cursor: "pointer",
    fontSize: 13,
    fontWeight: 800,
    whiteSpace: "nowrap",
  };

  const smallBtnPrimary: CSSProperties = {
    ...smallBtn,
    border: "none",
    background: "#047857",
    color: "white",
  };

  // Farmer “Do Now” strip + filtered list
  const {
    sowTodayTrays,
    harvestTodayTrays,
    deliverTodayCount,
    overdueCount,
    filteredGroups,
  } = useMemo(() => {
    let sowToday = 0;
    let harvestToday = 0;
    let deliverToday = 0;
    let overdue = 0;

    const filtered: OrderGroup[] = [];

    for (const group of groups) {
      const deliveryDate = group.deliveryDate;

      // We treat harvest as “day before delivery” (simple farmer rule-of-thumb)
      const harvestDate = deliveryDate ? subtractDaysYMD(deliveryDate, 1) : null;

      // Only actionable orders count toward “Deliver today” / “Overdue”
      const isDelivered = group.status === "delivered";

      let matchesFilter = false;

      // Overdue (delivery date passed, not delivered)
      if (deliveryDate && deliveryDate < todayYMD && !isDelivered) {
        overdue += 1;
        if (doNowFilter === "overdue") matchesFilter = true;
      }

      // Deliver today (not delivered yet)
      if (deliveryDate === todayYMD && !isDelivered) {
        deliverToday += 1;
        if (doNowFilter === "deliver") matchesFilter = true;
      }

      // Harvest today (trays)
      if (harvestDate === todayYMD && !isDelivered) {
        const groupTrays = group.lines.reduce(
          (sum, line) => sum + Number(line.quantity ?? 0),
          0
        );
        harvestToday += groupTrays;
        if (doNowFilter === "harvest") matchesFilter = true;
      }

      // Sow today (trays) — based on each line’s grow time
      let groupSowTrays = 0;
      if (deliveryDate && !isDelivered) {
        for (const line of group.lines) {
          const daysToHarvest = varietyGrowDays(line.varietyId);
          if (daysToHarvest > 0) {
            const sowDate = subtractDaysYMD(deliveryDate, daysToHarvest);
            if (sowDate === todayYMD) {
              groupSowTrays += Number(line.quantity ?? 0);
            }
          }
        }
      }

      if (groupSowTrays > 0) {
        sowToday += groupSowTrays;
        if (doNowFilter === "sow") matchesFilter = true;
      }

      // Include this order group if no filter OR matches the active filter
      if (doNowFilter === "none" || matchesFilter) {
        filtered.push(group);
      }
    }

    return {
      sowTodayTrays: sowToday,
      harvestTodayTrays: harvestToday,
      deliverTodayCount: deliverToday,
      overdueCount: overdue,
      filteredGroups: filtered,
    };
  }, [groups, varieties, doNowFilter, todayYMD]);

  return (
    <div className="page">
      <h1 className="page-title">Orders </h1>

      {/* Today's Do Now Strip */}
      <div
        style={{
          backgroundColor: "#f8fafc",
          borderRadius: "14px",
          padding: "16px",
          marginBottom: "16px",
          border: "1px solid #e2e8f0",
        }}
      >
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            marginBottom: "12px",
            gap: 12,
          }}
        >
          <h3 style={{ margin: 0, fontSize: "16px", color: "#0f172a" }}>
            Today’s Do Now
          </h3>

          {doNowFilter !== "none" && (
            <button
              onClick={() => setDoNowFilter("none")}
              style={{
                background: "none",
                border: "none",
                color: "#3b82f6",
                cursor: "pointer",
                fontSize: "14px",
                fontWeight: 600,
                padding: "4px 8px",
              }}
            >
              Clear filter
            </button>
          )}
        </div>

        <div style={{ display: "flex", gap: "12px", flexWrap: "wrap" }}>
          <DoNowPill
            label="Sow today"
            count={sowTodayTrays}
            unit="trays"
            isActive={doNowFilter === "sow"}
            onClick={() => setDoNowFilter(doNowFilter === "sow" ? "none" : "sow")}
          />
          <DoNowPill
            label="Harvest today"
            count={harvestTodayTrays}
            unit="trays"
            isActive={doNowFilter === "harvest"}
            onClick={() =>
              setDoNowFilter(doNowFilter === "harvest" ? "none" : "harvest")
            }
          />
          <DoNowPill
            label="Deliver today"
            count={deliverTodayCount}
            unit="orders"
            isActive={doNowFilter === "deliver"}
            onClick={() =>
              setDoNowFilter(doNowFilter === "deliver" ? "none" : "deliver")
            }
          />
          <DoNowPill
            label="Overdue"
            count={overdueCount}
            unit="orders"
            isActive={doNowFilter === "overdue"}
            variant={overdueCount > 0 ? "error" : "default"}
            onClick={() =>
              setDoNowFilter(doNowFilter === "overdue" ? "none" : "overdue")
            }
          />
        </div>
      </div>

      <div style={{ marginTop: "0.75rem", marginBottom: "0.75rem" }}>
        <button onClick={() => navigate("/orders/new")} style={primaryBtn}>
          New Order
        </button>
      </div>

      {loading && <p className="page-text">Loading…</p>}
      {error && (
        <p className="page-text" style={{ color: "#b91c1c" }}>
          {error}
        </p>
      )}

      {!loading && !error && filteredGroups.length === 0 ? (
        <p className="page-text">
          {doNowFilter === "none"
            ? "No orders yet. Create a customer and variety, then add your first order."
            : "Nothing matches this Do Now filter today."}
        </p>
      ) : null}

      {!loading && !error && filteredGroups.length > 0 ? (
        <div style={{ marginTop: "0.5rem" }}>
          {filteredGroups.map((g) => {
            const totalTrays = g.lines.reduce(
              (sum, x) => sum + Number(x.quantity ?? 0),
              0
            );

            // Variety breakdown
            const breakdown = new Map<string, number>();
            for (const line of g.lines) {
              breakdown.set(
                line.varietyId,
                (breakdown.get(line.varietyId) ?? 0) + Number(line.quantity ?? 0)
              );
            }

            const breakdownList = Array.from(breakdown.entries())
              .map(([varietyId, qty]) => ({
                varietyId,
                qty,
                name: varietyName(varietyId),
              }))
              .sort((a, b) => b.qty - a.qty || a.name.localeCompare(b.name));

            // Earliest suggested sow date across lines
            let earliestSow: string | null = null;
            for (const line of g.lines) {
              const days = varietyGrowDays(line.varietyId);
              if (days > 0 && g.deliveryDate) {
                const sow = subtractDaysYMD(g.deliveryDate, days);
                if (!earliestSow || sow < earliestSow) earliestSow = sow;
              }
            }

            const num = displayOrderNumber(g.key);

            return (
              <div
                key={g.key}
                style={{
                  width: "100%",
                  textAlign: "left",
                  padding: "0.9rem 1rem",
                  borderRadius: "14px",
                  border: "1px solid #e2e8f0",
                  marginBottom: "0.65rem",
                  background: "#fff",
                }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    gap: 12,
                    alignItems: "flex-start",
                  }}
                >
                  <div style={{ minWidth: 0 }}>
                    <div style={{ fontWeight: 900, fontSize: 16, color: "#0f172a" }}>
                      {customerName(g.customerId)}
                    </div>
                    <div style={{ fontSize: 12, color: "#64748b", marginTop: 2 }}>
                      <strong>{num}</strong> • Delivery{" "}
                      {formatDisplayDate(g.deliveryDate)} ({ymdToDow(g.deliveryDate)})
                    </div>

                    <div style={{ marginTop: 10, display: "flex", gap: 8, flexWrap: "wrap" }}>
                      <button
                        style={smallBtn}
                        onClick={() => navigate(`/orders/${encodeURIComponent(g.key)}`)}
                      >
                        View
                      </button>

                      {g.status !== "packed" && g.status !== "delivered" && (
                        <button
                          style={smallBtn}
                          onClick={() => updateGroupStatus(g, "packed")}
                        >
                          Mark Packed
                        </button>
                      )}

                      {g.status !== "delivered" && (
                        <button
                          style={smallBtnPrimary}
                          onClick={() => updateGroupStatus(g, "delivered")}
                        >
                          Mark Delivered
                        </button>
                      )}
                    </div>
                  </div>

                  <span
                    style={{
                      fontSize: 12,
                      padding: "3px 10px",
                      borderRadius: 999,
                      background: "#f1f5f9",
                      color: "#0f172a",
                      textTransform: "capitalize",
                      whiteSpace: "nowrap",
                      height: "fit-content",
                    }}
                    title={
                      g.status === "draft"
                        ? "Draft = not confirmed yet."
                        : g.status === "confirmed"
                        ? "Confirmed = you are producing this."
                        : g.status === "packed"
                        ? "Packed = ready to deliver."
                        : "Delivered = completed."
                    }
                  >
                    {g.status}
                  </span>
                </div>

                <div style={{ marginTop: 10, display: "flex", gap: 10, flexWrap: "wrap" }}>
                  <span
                    style={{
                      fontSize: 12,
                      padding: "2px 10px",
                      borderRadius: 999,
                      background: "#ecfdf5",
                      color: "#065f46",
                      fontWeight: 900,
                    }}
                  >
                    Total trays: {totalTrays}
                  </span>

                  {earliestSow ? (
                    <span
                      style={{
                        fontSize: 12,
                        padding: "2px 10px",
                        borderRadius: 999,
                        background: "#eff6ff",
                        color: "#1e3a8a",
                        fontWeight: 900,
                      }}
                      title="Earliest sow date across all lines (start here to protect on-time delivery)."
                    >
                      Earliest sow: {formatDisplayDate(earliestSow)}
                    </span>
                  ) : (
                    <span
                      style={{
                        fontSize: 12,
                        padding: "2px 10px",
                        borderRadius: 999,
                        background: "#fff7ed",
                        color: "#9a3412",
                        fontWeight: 900,
                      }}
                      title="Set harvest days in Varieties to get sow date suggestions."
                    >
                      Set harvest days for sow suggestions
                    </span>
                  )}
                </div>

                <div style={{ marginTop: 10, fontSize: 13, color: "#0f172a" }}>
                  <div style={{ fontWeight: 900, marginBottom: 6 }}>Variety breakdown</div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    {breakdownList.map((b) => {
                      const days = varietyGrowDays(b.varietyId);
                      const sow =
                        days > 0 && g.deliveryDate
                          ? subtractDaysYMD(g.deliveryDate, days)
                          : null;

                      return (
                        <div
                          key={b.varietyId}
                          style={{
                            display: "flex",
                            justifyContent: "space-between",
                            gap: 12,
                            borderBottom: "1px solid #f1f5f9",
                            paddingBottom: 4,
                          }}
                        >
                          <div style={{ fontWeight: 800 }}>
                            {b.qty} × {b.name}
                          </div>
                          <div style={{ fontSize: 12, color: "#64748b", whiteSpace: "nowrap" }}>
                            {sow ? `Sow ${formatDisplayDate(sow)} (${days}d)` : "—"}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      ) : null}
    </div>
  );
}

/* ----------------- ORDER DETAIL (EDIT/DELETE GROUP) ----------------- */

function OrderDetailPage() {
  const navigate = useNavigate();
  const params = useParams();
  const groupKey = decodeURIComponent(params.groupKey ?? "");

  const [orders, setOrders] = useState<Order[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [varieties, setVarieties] = useState<Variety[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const groups = useMemo(() => buildOrderGroups(orders), [orders]);
  const group = useMemo(
    () => groups.find((g) => g.key === groupKey) ?? null,
    [groups, groupKey]
  );

  const [deliveryDate, setDeliveryDate] = useState("");
  const [status, setStatus] = useState<OrderStatus>("confirmed");
  const [lines, setLines] = useState<
    Array<{ id: string; varietyId: string; quantity: number }>
  >([]);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        setError(null);

        const [os, cs, vs] = await Promise.all([
          getOrdersSB(),
          getCustomersSB(),
          fetchVarietiesForOrders(),
        ]);

        if (!alive) return;

        setOrders(os);
        setCustomers(cs);
        setVarieties(vs);
      } catch (e: any) {
        if (!alive) return;
        setError(e?.message ?? "Failed to load order.");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [groupKey]);

  useEffect(() => {
    if (!group) return;
    setDeliveryDate(group.deliveryDate);
    setStatus(group.status);
    setLines(
      group.lines.map((l) => ({
        id: l.id,
        varietyId: l.varietyId,
        quantity: Number(l.quantity ?? 0),
      }))
    );
  }, [group?.key]); // eslint-disable-line react-hooks/exhaustive-deps

  const customer = useMemo(() => {
    if (!group) return null;
    return customers.find((c) => c.id === group.customerId) ?? null;
  }, [group, customers]);

  const varietyGrowDays = (id: string) =>
    Number(varieties.find((v) => v.id === id)?.daysToHarvest ?? 0);

  const orderNumber = group ? displayOrderNumber(group.key) : "TF-______";

  const computedEarliestSow = useMemo(() => {
    if (!deliveryDate) return null;
    let earliest: string | null = null;
    for (const l of lines) {
      const days = varietyGrowDays(l.varietyId);
      if (days > 0) {
        const sow = subtractDaysYMD(deliveryDate, days);
        if (!earliest || sow < earliest) earliest = sow;
      }
    }
    return earliest;
  }, [deliveryDate, lines, varieties]);

  const totalTrays = useMemo(
    () => lines.reduce((sum, l) => sum + Number(l.quantity ?? 0), 0),
    [lines]
  );

  const addLine = () => {
    const first = varieties[0]?.id ?? "";
    setLines((prev) => [
      ...prev,
      {
        id:
          typeof crypto !== "undefined" && "randomUUID" in crypto
            ? (crypto as any).randomUUID()
            : `tmp_${Date.now()}_${Math.random().toString(16).slice(2)}`,
        varietyId: first,
        quantity: 1,
      },
    ]);
  };

  const removeLine = (id: string) => {
    setLines((prev) => prev.filter((l) => l.id !== id));
  };

  const updateLine = (
    id: string,
    patch: Partial<{ varietyId: string; quantity: number }>
  ) => {
    setLines((prev) =>
      prev.map((l) => (l.id === id ? { ...l, ...patch } : l))
    );
  };

  const reload = async () => {
    const os = await getOrdersSB();
    setOrders(os);
  };

  const saveChanges = async () => {
    if (!group) return;
    if (!deliveryDate) {
      alert("Please choose a delivery date.");
      return;
    }
    if (lines.length === 0) {
      alert("An order needs at least one line. (Or delete the order.)");
      return;
    }
    for (const l of lines) {
      if (!l.varietyId) {
        alert("Each line needs a variety.");
        return;
      }
      if (!l.quantity || l.quantity <= 0) {
        alert("Each line needs quantity > 0.");
        return;
      }
    }

    setSaving(true);
    try {
      const existingIds = new Set(group.lines.map((x) => x.id));
      const draftIds = new Set(lines.map((x) => x.id));

      // 1) delete removed lines (rows in DB)
      const toDelete = group.lines
        .filter((x) => !draftIds.has(x.id))
        .map((x) => x.id);
      if (toDelete.length) {
  // delete tasks linked to these order lines first
  const { error: tErr } = await supabase.from("tasks").delete().in("order_id", toDelete);
  if (tErr) throw new Error(tErr.message);

  const { error } = await supabase.from("orders").delete().in("id", toDelete);
  if (error) throw new Error(error.message);
}

      // 2) update existing lines
      const toUpdate = lines.filter((l) => existingIds.has(l.id));
      for (const l of toUpdate) {
        const { error } = await supabase
          .from("orders")
          .update({
            variety_id: l.varietyId,
            quantity: Number(l.quantity),
            delivery_date: deliveryDate,
            status,
          })
          .eq("id", l.id);
        if (error) throw new Error(error.message);
      }

      // 3) insert new lines
      // insert new lines (use addOrder so tasks auto-generate)
const toInsert = lines.filter((l) => !existingIds.has(l.id));
for (const l of toInsert) {
  await addOrder({
    customerId: group.customerId,
    varietyId: l.varietyId,
    quantity: Number(l.quantity),
    deliveryDate,
    status,
  });
}

      await reload();
      alert("Order updated ✅");
      navigate("/orders");
    } catch (e: any) {
      alert(e?.message ?? "Failed to save changes.");
    } finally {
      setSaving(false);
    }
  };

  const deleteOrderGroup = async () => {
    if (!group) return;
    const ok = window.confirm(
      `Delete ${orderNumber}?\n\nThis deletes ALL lines in the order.`
    );
    if (!ok) return;

    setSaving(true);
    try {
      const ids = group.lines.map((x) => x.id);

const { error: tErr } = await supabase.from("tasks").delete().in("order_id", ids);
if (tErr) throw new Error(tErr.message);

const { error } = await supabase.from("orders").delete().in("id", ids);
if (error) throw new Error(error.message);

      alert("Order deleted ✅");
      navigate("/orders");
    } catch (e: any) {
      alert(e?.message ?? "Failed to delete order.");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="page">
        <h1 className="page-title">Order</h1>
        <p className="page-text">Loading…</p>
      </div>
    );
  }

  if (error || !group) {
    return (
      <div className="page">
        <h1 className="page-title">Order</h1>
        <p className="page-text" style={{ color: "#b91c1c" }}>
          {error ?? "Order not found. (It may have been deleted.)"}
        </p>
        <button onClick={() => navigate("/orders")} style={secondaryBtn}>
          Back to Orders
        </button>
      </div>
    );
  }

  return (
    <div className="page">
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          gap: 12,
          flexWrap: "wrap",
        }}
      >
        <div>
          <h1 className="page-title" style={{ marginBottom: 6 }}>
            {customer?.name ?? "Customer"}
          </h1>
          <div style={{ fontSize: 13, color: "#64748b" }}>
            <strong>{orderNumber}</strong> • Created bucket{" "}
            {group.createdAtMs ? new Date(group.createdAtMs).toLocaleString() : "—"}
          </div>
        </div>

        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <button onClick={() => navigate("/orders")} style={secondaryBtn} disabled={saving}>
            Back
          </button>
          <button
            onClick={deleteOrderGroup}
            style={{
              ...secondaryBtn,
              border: "1px solid #fecaca",
              color: "#b91c1c",
            }}
            disabled={saving}
            title="Deletes the entire order (all lines)."
          >
            Delete Order
          </button>
          <button onClick={saveChanges} style={primaryBtn} disabled={saving}>
            {saving ? "Saving..." : "Save Changes"}
          </button>
        </div>
      </div>

      <div
        style={{
          marginTop: 14,
          border: "1px solid #e2e8f0",
          borderRadius: 12,
          background: "#fff",
          padding: 12,
          maxWidth: 820,
        }}
      >
        <div style={{ display: "flex", gap: 12, flexWrap: "wrap", alignItems: "flex-end" }}>
          <div style={{ width: 240 }}>
            <div style={miniLabel}>Delivery date</div>
            <input
              type="date"
              value={deliveryDate}
              onChange={(e) => setDeliveryDate(e.target.value)}
              style={controlStyle}
            />
          </div>

          <div style={{ width: 220 }}>
            <div style={miniLabel}>Status</div>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value as OrderStatus)}
              style={controlStyle}
            >
              <option value="draft">Draft</option>
              <option value="confirmed">Confirmed</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>

          <div
            style={{
              flex: 1,
              minWidth: 240,
              border: "1px solid #e2e8f0",
              borderRadius: 12,
              padding: "0.6rem 0.75rem",
              background: "#f8fafc",
            }}
          >
            <div style={{ display: "flex", justifyContent: "space-between", gap: 10 }}>
              <div>
                <div style={{ fontSize: 12, color: "#64748b" }}>Total trays</div>
                <div style={{ fontSize: 16, fontWeight: 900, color: "#0f172a" }}>
                  {totalTrays}
                </div>
              </div>
              <div style={{ textAlign: "right" }}>
                <div style={{ fontSize: 12, color: "#64748b" }}>Earliest sow</div>
                <div style={{ fontSize: 14, fontWeight: 900, color: "#0f172a" }}>
                  {computedEarliestSow ? formatDisplayDate(computedEarliestSow) : "—"}
                </div>
              </div>
            </div>
            <div style={{ marginTop: 8, fontSize: 12, color: "#64748b" }}>
              Master grower note: earliest sow date protects on-time delivery when trays vary.
            </div>
          </div>
        </div>

        <div style={{ marginTop: 14 }}>
          <div style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "center" }}>
            <div style={{ fontWeight: 900, color: "#0f172a" }}>Order lines</div>
            <button type="button" onClick={addLine} style={secondaryBtn} disabled={saving}>
              + Add line
            </button>
          </div>

          <div style={{ marginTop: 10, display: "flex", flexDirection: "column", gap: 10 }}>
            {lines.map((l) => {
              const days = varietyGrowDays(l.varietyId);
              const sow = deliveryDate && days > 0 ? subtractDaysYMD(deliveryDate, days) : null;

              return (
                <div
                  key={l.id}
                  style={{
                    border: "1px solid #e2e8f0",
                    borderRadius: 12,
                    padding: "0.75rem",
                    background: "#fff",
                  }}
                >
                  <div
                    style={{
                      display: "grid",
                      gridTemplateColumns: "1.4fr 120px 180px 44px",
                      gap: 10,
                      alignItems: "end",
                    }}
                  >
                    <div>
                      <div style={miniLabel}>Variety</div>
                      <select
                        value={l.varietyId}
                        onChange={(e) => updateLine(l.id, { varietyId: e.target.value })}
                        style={controlStyle}
                        disabled={saving}
                      >
                        <option value="">Select a variety</option>
                        {varieties.map((v) => (
                          <option key={v.id} value={v.id}>
                            {v.name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <div style={miniLabel}>Trays</div>
                      <input
                        type="number"
                        min={1}
                        value={l.quantity}
                        onChange={(e) => updateLine(l.id, { quantity: Number(e.target.value) })}
                        style={controlStyle}
                        disabled={saving}
                      />
                    </div>

                    <div>
                      <div style={miniLabel}>Suggested sow</div>
                      <div
                        style={{
                          border: "1px solid #e2e8f0",
                          borderRadius: 8,
                          padding: "0.55rem 0.6rem",
                          background: "#f8fafc",
                          fontSize: 14,
                          fontWeight: 900,
                          color: "#0f172a",
                        }}
                        title={days > 0 ? `${days} day grow` : "Set harvest days in Varieties"}
                      >
                        {sow ? `${formatDisplayDate(sow)} (${days}d)` : "—"}
                      </div>
                    </div>

                    <button
                      type="button"
                      onClick={() => removeLine(l.id)}
                      style={{
                        border: "1px solid #fecaca",
                        background: "#fff",
                        color: "#b91c1c",
                        borderRadius: 10,
                        height: 42,
                        cursor: "pointer",
                        fontSize: 16,
                      }}
                      disabled={saving || lines.length <= 1}
                      title={lines.length <= 1 ? "Order must have at least 1 line" : "Remove line"}
                    >
                      ×
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <div style={{ marginTop: 12, fontSize: 12, color: "#64748b" }}>
          Note: This order is stored as multiple rows behind the scenes (one per line). This page edits them as a single “real order”.
        </div>
      </div>
    </div>
  );
}

/* ----------------- NEW ORDER (Plan by Delivery or Sow) ----------------- */

function NewOrderPage() {
  const navigate = useNavigate();

  const [customers, setCustomers] = useState<Customer[]>([]);
  const [varieties, setVarieties] = useState<Variety[]>([]);

  const [customerId, setCustomerId] = useState("");
  const [status, setStatus] = useState<OrderStatus>("confirmed");

  const [planMode, setPlanMode] = useState<"delivery" | "sow">("delivery");
  const [deliveryDate, setDeliveryDate] = useState("");
  const [sowDate, setSowDate] = useState("");

  const [lines, setLines] = useState<OrderLineDraft[]>([]);
  const [submitting, setSubmitting] = useState(false);
  const [loading, setLoading] = useState(true);

  const activeCustomers = useMemo(
    () => customers.filter((c) => c.active !== false),
    [customers]
  );

  const selectedCustomer = useMemo(
    () => activeCustomers.find((c) => c.id === customerId),
    [activeCustomers, customerId]
  );

  const makeId = () =>
    typeof crypto !== "undefined" && "randomUUID" in crypto
      ? (crypto as any).randomUUID()
      : `ln_${Date.now()}_${Math.random().toString(16).slice(2)}`;

  const addLine = (seedFromFirst = true) => {
    const firstVar = varieties[0]?.id ?? "";
    setLines((prev) => {
      const seed = seedFromFirst ? prev[0]?.seedGramsPerTray : undefined;
      return [
        ...prev,
        {
          id: makeId(),
          varietyId: firstVar,
          quantity: 1,
          seedGramsPerTray: seed,
          packSize: "",
          notes: "",
        },
      ];
    });
  };

  const removeLine = (id: string) => {
    setLines((prev) => prev.filter((l) => l.id !== id));
  };

  const updateLine = (id: string, patch: Partial<OrderLineDraft>) => {
    setLines((prev) => prev.map((l) => (l.id === id ? { ...l, ...patch } : l)));
  };

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        const [cs, vs] = await Promise.all([
          getCustomersSB(),
          fetchVarietiesForOrders(),
        ]);

        if (!alive) return;

        setCustomers(cs);
        setVarieties(vs);

        const act = cs.filter((c) => c.active !== false);
        if (act[0]) setCustomerId(act[0].id);

        const today = toYMD(new Date());
        setSowDate(today);
        setDeliveryDate(addDaysYMD(today, 2));

        setLines([
          {
            id: makeId(),
            varietyId: vs[0]?.id ?? "",
            quantity: 1,
            seedGramsPerTray: undefined,
            packSize: "",
            notes: "",
          },
        ]);
      } catch (e: any) {
        alert(e?.message ?? "Failed to load customers/varieties.");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const computed = useMemo(() => {
    const result = lines.map((l) => {
      const v = varieties.find((x) => x.id === l.varietyId);
      const growDays = Number(v?.daysToHarvest ?? 0);

      let computedDelivery = deliveryDate;
      let computedSow = sowDate;

      if (planMode === "delivery") {
        computedDelivery = deliveryDate;
        computedSow =
          deliveryDate && growDays > 0
            ? subtractDaysYMD(deliveryDate, growDays)
            : sowDate;
      } else {
        computedSow = sowDate;
        computedDelivery =
          sowDate && growDays > 0
            ? addDaysYMD(sowDate, growDays)
            : deliveryDate;
      }

      const gramsPerTray = Number(l.seedGramsPerTray ?? 0);
      const totalGrams =
        gramsPerTray > 0 ? gramsPerTray * Number(l.quantity ?? 0) : 0;

      return {
        line: l,
        varietyName: v?.name ?? "Unknown variety",
        growDays,
        sow: computedSow || "",
        delivery: computedDelivery || "",
        gramsPerTray: gramsPerTray > 0 ? gramsPerTray : null,
        totalGrams: totalGrams > 0 ? totalGrams : null,
      };
    });

    const orderDelivery = result.find((x) => x.delivery)?.delivery ?? deliveryDate;
    const orderSow = result.find((x) => x.sow)?.sow ?? sowDate;

    const totalTrays = result.reduce((sum, x) => sum + Number(x.line.quantity ?? 0), 0);
    const totalSeed = result.reduce((sum, x) => sum + Number(x.totalGrams ?? 0), 0);

    return { lines: result, orderDelivery, orderSow, totalTrays, totalSeed };
  }, [lines, varieties, planMode, deliveryDate, sowDate]);

  const statusHelp =
    status === "draft"
      ? "Draft = not confirmed yet (quote / holding place). No production commitment."
      : status === "confirmed"
      ? "Confirmed = committed. TrayFlow will treat this as something you are producing."
      : "Delivered = completed. Use this after drop-off / pickup is done.";

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();

    if (!customerId) {
      alert("Please select a customer.");
      return;
    }
    if (!lines.length) {
      alert("Add at least one variety line.");
      return;
    }

    for (const l of lines) {
      if (!l.varietyId) {
        alert("Each line needs a variety selected.");
        return;
      }
      if (!l.quantity || l.quantity <= 0) {
        alert("Each line needs a tray quantity greater than 0.");
        return;
      }
    }

    const baseDelivery = computed.orderDelivery;
    const baseSow = computed.orderSow;

    if (planMode === "delivery" && !baseDelivery) {
      alert("Please select a delivery date.");
      return;
    }
    if (planMode === "sow" && !baseSow) {
      alert("Please select a sow date.");
      return;
    }

    setSubmitting(true);
    try {
      for (const c of computed.lines) {
        const created = await addOrderSB({
          customerId,
          varietyId: c.line.varietyId,
          quantity: Number(c.line.quantity),
          deliveryDate: c.delivery,
          status,
        });

        if (c.sow) {
          const sowSeedNote =
            c.gramsPerTray && c.totalGrams
              ? ` • Seed: ${c.gramsPerTray}g/tray (${c.totalGrams}g total)`
              : "";

          await addTaskSB({
            title: `Sow: ${c.varietyName} x${c.line.quantity} → ${
              selectedCustomer?.name ?? "Customer"
            }${sowSeedNote}`,
            dueDate: c.sow,
            status: "planned",
            orderId: created.id,
          });
        }

        await addTaskSB({
          title: `Delivery: ${c.varietyName} x${c.line.quantity} → ${
            selectedCustomer?.name ?? "Customer"
          }`,
          dueDate: c.delivery,
          status: "planned",
          orderId: created.id,
        });
      }

      navigate("/orders");
    } catch (e: any) {
      alert(e?.message ?? "Failed to save order.");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="page">
      <h1 className="page-title">New Order</h1>

      {loading ? (
        <p className="page-text" style={{ marginTop: "0.75rem" }}>
          Loading…
        </p>
      ) : (
        <form onSubmit={handleSubmit} style={{ marginTop: "0.75rem", maxWidth: 720 }}>
          <div style={{ marginBottom: "0.9rem" }}>
            <label style={labelStyle}>Customer</label>
            <select
              value={customerId}
              onChange={(e) => setCustomerId(e.target.value)}
              style={controlStyle}
            >
              <option value="">Select a customer</option>
              {activeCustomers.map((c) => (
                <option key={c.id} value={c.id}>
                  {c.name}
                </option>
              ))}
            </select>
            <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>
              {selectedCustomer?.priceTier ? (
                <>
                  Price tier: <strong>{selectedCustomer.priceTier}</strong>
                </>
              ) : (
                <>Tip: set a customer price tier in Customers → Billing.</>
              )}
            </div>
          </div>

          <div style={{ marginBottom: "0.9rem" }}>
            <div style={{ display: "flex", gap: 12, alignItems: "flex-end", flexWrap: "wrap" }}>
              <div style={{ width: 240 }}>
                <label style={labelStyle}>Plan by</label>
                <select
                  value={planMode}
                  onChange={(e) => setPlanMode(e.target.value as any)}
                  style={controlStyle}
                >
                  <option value="delivery">Delivery date (most common)</option>
                  <option value="sow">Sow date (reverse plan)</option>
                </select>
              </div>

              {planMode === "delivery" ? (
                <div style={{ width: 240 }}>
                  <label style={labelStyle}>Delivery date</label>
                  <input
                    type="date"
                    value={deliveryDate}
                    onChange={(e) => setDeliveryDate(e.target.value)}
                    style={controlStyle}
                  />
                  <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>
                    We’ll suggest sow dates per variety using each variety’s harvest days.
                  </div>
                </div>
              ) : (
                <div style={{ width: 240 }}>
                  <label style={labelStyle}>Sow date</label>
                  <input
                    type="date"
                    value={sowDate}
                    onChange={(e) => setSowDate(e.target.value)}
                    style={controlStyle}
                  />
                  <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>
                    We’ll suggest delivery dates per variety using harvest days.
                  </div>
                </div>
              )}

              <div
                style={{
                  flex: 1,
                  minWidth: 220,
                  border: "1px solid #e2e8f0",
                  borderRadius: 12,
                  padding: "0.6rem 0.75rem",
                  background: "#fff",
                }}
              >
                <div style={{ display: "flex", justifyContent: "space-between", gap: 10 }}>
                  <div>
                    <div style={{ fontSize: 12, color: "#64748b" }}>Order summary</div>
                    <div style={{ fontSize: 14, fontWeight: 900, color: "#0f172a" }}>
                      {computed.totalTrays} trays
                    </div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 12, color: "#64748b" }}>Total seed (if entered)</div>
                    <div style={{ fontSize: 14, fontWeight: 900, color: "#0f172a" }}>
                      {computed.totalSeed ? `${computed.totalSeed}g` : "—"}
                    </div>
                  </div>
                </div>

                <div style={{ marginTop: 8, fontSize: 12, color: "#64748b" }}>
                  Sow: <strong>{computed.orderSow ? formatDisplayDate(computed.orderSow) : "—"}</strong>{" "}
                  • Delivery:{" "}
                  <strong>{computed.orderDelivery ? formatDisplayDate(computed.orderDelivery) : "—"}</strong>
                </div>
              </div>
            </div>
          </div>

          <div style={{ marginBottom: "0.9rem" }}>
            <label style={labelStyle}>Status</label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value as OrderStatus)}
              style={controlStyle}
            >
              <option value="draft">Draft</option>
              <option value="confirmed">Confirmed</option>
              <option value="delivered">Delivered</option>
            </select>
            <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>{statusHelp}</div>
          </div>

          <div style={{ marginBottom: "0.9rem" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
              <div>
                <div style={{ fontWeight: 900, fontSize: 14, color: "#0f172a" }}>
                  Order lines (multiple varieties)
                </div>
                <div style={{ fontSize: 12, color: "#64748b", marginTop: 4 }}>
                  Each line becomes a separate order record behind the scenes, but will display as ONE order in Orders.
                </div>
              </div>

              <button type="button" onClick={() => addLine(true)} style={secondaryBtn}>
                + Add variety
              </button>
            </div>

            <div style={{ marginTop: 10, display: "flex", flexDirection: "column", gap: 10 }}>
              {computed.lines.map((c) => (
                <div
                  key={c.line.id}
                  style={{
                    border: "1px solid #e2e8f0",
                    borderRadius: 12,
                    background: "#fff",
                    padding: "0.75rem",
                  }}
                >
                  <div
                    style={{
                      display: "grid",
                      gridTemplateColumns: "1.3fr 120px 140px 44px",
                      gap: 10,
                      alignItems: "end",
                    }}
                  >
                    <div>
                      <div style={miniLabel}>Variety</div>
                      <select
                        value={c.line.varietyId}
                        onChange={(e) => updateLine(c.line.id, { varietyId: e.target.value })}
                        style={controlStyle}
                      >
                        <option value="">Select a variety</option>
                        {varieties.map((v) => (
                          <option key={v.id} value={v.id}>
                            {v.name}
                          </option>
                        ))}
                      </select>
                      <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>
                        Grow time: <strong>{c.growDays > 0 ? `${c.growDays} days` : "—"}</strong>
                        {c.growDays <= 0 ? " (set harvest days in Varieties)" : null}
                      </div>
                    </div>

                    <div>
                      <div style={miniLabel}>Trays</div>
                      <input
                        type="number"
                        min={1}
                        value={c.line.quantity}
                        onChange={(e) => updateLine(c.line.id, { quantity: Number(e.target.value) })}
                        style={controlStyle}
                      />
                    </div>

                    <div>
                      <div style={miniLabel}>Suggested sow</div>
                      <div
                        style={{
                          border: "1px solid #e2e8f0",
                          borderRadius: 8,
                          padding: "0.55rem 0.6rem",
                          background: "#f8fafc",
                          fontSize: 14,
                          fontWeight: 900,
                          color: "#0f172a",
                        }}
                      >
                        {c.sow ? formatDisplayDate(c.sow) : "—"}
                      </div>
                      <div style={{ marginTop: 6, fontSize: 12, color: "#64748b" }}>
                        Delivery: <strong>{c.delivery ? formatDisplayDate(c.delivery) : "—"}</strong>
                      </div>
                    </div>

                    <button
                      type="button"
                      onClick={() => removeLine(c.line.id)}
                      title="Remove line"
                      style={{
                        border: "1px solid #fecaca",
                        background: "#fff",
                        color: "#b91c1c",
                        borderRadius: 10,
                        height: 42,
                        cursor: "pointer",
                        fontSize: 16,
                      }}
                      disabled={lines.length <= 1}
                    >
                      ×
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ display: "flex", gap: "0.5rem", marginTop: "1rem" }}>
            <button type="submit" disabled={submitting} style={primaryBtn}>
              {submitting ? "Saving..." : "Save Order"}
            </button>

            <button
              type="button"
              onClick={() => navigate("/orders")}
              style={secondaryBtn}
              disabled={submitting}
            >
              Cancel
            </button>
          </div>

          <div style={{ marginTop: 10, fontSize: 12, color: "#64748b" }}>
            When you save: TrayFlow creates (1) a <strong>Sow</strong> task on the suggested sow date and (2) a{" "}
            <strong>Delivery</strong> task on the delivery date for each line.
          </div>
        </form>
      )}
    </div>
  );
}

/* ----------------- TASKS ----------------- */



/* ----------------- CALENDAR ----------------- */

function CalendarPage() {
  const location = useLocation();
  const [events, setEvents] = useState<Event[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        setError(null);
        const loaded = await getEventsSB();
        const sorted = [...loaded].sort((a, b) => a.date.localeCompare(b.date));
        if (!alive) return;
        setEvents(sorted);
      } catch (e: any) {
        if (!alive) return;
        setError(e?.message ?? "Failed to load events.");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [location.key]);

  if (loading) {
    return (
      <div className="page">
        <h1 className="page-title">Calendar</h1>
        <p className="page-text">Loading…</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="page">
        <h1 className="page-title">Calendar</h1>
        <p className="page-text" style={{ color: "#b91c1c" }}>
          {error}
        </p>
      </div>
    );
  }

  if (!events.length) {
    return (
      <div className="page">
        <h1 className="page-title">Calendar</h1>
        <p className="page-text">
          No events yet. Create tasks or orders to see sow/harvest/delivery events here.
        </p>
      </div>
    );
  }

  return (
    <div className="page">
      <h1 className="page-title">Calendar</h1>
      <div style={{ marginTop: "0.75rem" }}>
        {events.map((event) => (
          <div
            key={event.id}
            style={{
              padding: "0.75rem 1rem",
              borderRadius: "12px",
              border: "1px solid #e2e8f0",
              marginBottom: "0.5rem",
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              fontSize: 14,
              gap: "0.75rem",
              background: "#fff",
            }}
          >
            <div style={{ minWidth: 0 }}>
              <div style={{ fontWeight: 800 }}>{event.title}</div>
              <div style={{ fontSize: "0.8rem", color: "#64748b", marginTop: "0.15rem" }}>
                {formatDisplayDate(event.date)}
              </div>
            </div>

            <span
              style={{
                fontSize: "0.75rem",
                padding: "0.15rem 0.6rem",
                borderRadius: "999px",
                background: "#ecfeff",
                color: "#0e7490",
                textTransform: "capitalize",
                whiteSpace: "nowrap",
              }}
            >
              {event.type}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ----------------- PRODUCTION SHEET + SETTINGS ----------------- */

function ProductionSheetPage() {
  return (
    <div className="page">
      <h1 className="page-title">Production Sheet</h1>
      <p className="page-text">
        Production planning view coming next (standing orders → trays by day/variety).
      </p>
    </div>
  );
}

function SettingsPage() {
  return (
    <div className="page">
      <h1 className="page-title">Settings</h1>
      <p className="page-text">Farm and account settings will go here.</p>
    </div>
  );
}

/* ----------------- Small UI bits (icons + pills) ----------------- */

function TasksDoNowPill({
  label,
  value,
  icon,
  active,
  onClick,
  tone = "neutral",
}: {
  label: string;
  value: number;
  icon: React.ReactNode;
  active: boolean;
  onClick: () => void;
  tone?: "neutral" | "danger";
}) {
  const bg = active ? (tone === "danger" ? "#fee2e2" : "#e0f2fe") : "#f1f5f9";
  const fg = active ? (tone === "danger" ? "#b91c1c" : "#0369a1") : "#0f172a";

  return (
    <button
      onClick={onClick}
      style={{
        border: "1px solid #e2e8f0",
        background: bg,
        color: fg,
        borderRadius: 14,
        padding: "0.65rem 0.85rem",
        cursor: "pointer",
        minWidth: 140,
        textAlign: "left",
        display: "flex",
        gap: 10,
        alignItems: "center",
      }}
      title="Click to filter"
    >
      <div style={{ flexShrink: 0 }}>{icon}</div>
      <div style={{ lineHeight: 1.15 }}>
        <div style={{ fontSize: 12, opacity: 0.9, fontWeight: 900 }}>{label}</div>
        <div style={{ fontSize: 20, fontWeight: 900 }}>{value}</div>
      </div>
    </button>
  );
}

function TaskIcon({ type }: { type: any }) {
  const common = { width: 22, height: 22 };
  switch (type) {
    case "sow":
      return <IconSow {...common} />;
    case "water":
      return <IconWater {...common} />;
    case "spray":
      return <IconSpray {...common} />;
    case "blackout":
      return <IconBlackout {...common} />;
    case "lights_on":
      return <IconLightsOn {...common} />;
    case "harvest":
      return <IconHarvest {...common} />;
    case "delivery":
      return <IconDelivery {...common} />;
    default:
      return <IconClipboard {...common} />;
  }
}

/* ----------------- Simple inline SVG icons ----------------- */
/* These are “safe” icons (no dependencies) and match your clean style. */

function IconBase({
  children,
  width = 20,
  height = 20,
}: {
  children: React.ReactNode;
  width?: number;
  height?: number;
}) {
  return (
    <svg
      width={width}
      height={height}
      viewBox="0 0 24 24"
      fill="none"
      style={{ display: "block" }}
      xmlns="http://www.w3.org/2000/svg"
    >
      {children}
    </svg>
  );
}

function IconSow(props: any) {
  return (
    <IconBase {...props}>
      <path d="M12 3c-4 3-6 6-6 9a6 6 0 0012 0c0-3-2-6-6-9z" stroke="currentColor" strokeWidth="2" />
      <path d="M8 20c1.2-2 3-3 4-3s2.8 1 4 3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </IconBase>
  );
}

function IconWater(props: any) {
  return (
    <IconBase {...props}>
      <path d="M12 3c-3 4-5 7-5 10a5 5 0 0010 0c0-3-2-6-5-10z" stroke="currentColor" strokeWidth="2" />
    </IconBase>
  );
}

function IconSpray(props: any) {
  return (
    <IconBase {...props}>
      <path d="M7 7h6l1 2H8L7 7z" stroke="currentColor" strokeWidth="2" />
      <path d="M8 9v10a2 2 0 002 2h2a2 2 0 002-2V9" stroke="currentColor" strokeWidth="2" />
      <path d="M15 6h2a2 2 0 012 2v1" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M19 9c1 0 2-1 2-2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </IconBase>
  );
}

function IconBlackout(props: any) {
  return (
    <IconBase {...props}>
      <path d="M4 8h16v12H4V8z" stroke="currentColor" strokeWidth="2" />
      <path d="M8 8V6a4 4 0 018 0v2" stroke="currentColor" strokeWidth="2" />
      <path d="M9 14h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </IconBase>
  );
}

function IconLightsOn(props: any) {
  return (
    <IconBase {...props}>
      <path d="M9 21h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M12 3a6 6 0 00-3 11c.6.4 1 1.2 1 2h4c0-.8.4-1.6 1-2a6 6 0 00-3-11z" stroke="currentColor" strokeWidth="2" />
      <path d="M12 5v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </IconBase>
  );
}

function IconHarvest(props: any) {
  return (
    <IconBase {...props}>
      <path d="M6 18c6 0 9-3 12-10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M8 8c2 0 3 1 3 3-2 0-3-1-3-3z" stroke="currentColor" strokeWidth="2" />
      <path d="M13 10c2 0 3 1 3 3-2 0-3-1-3-3z" stroke="currentColor" strokeWidth="2" />
    </IconBase>
  );
}

function IconDelivery(props: any) {
  return (
    <IconBase {...props}>
      <path d="M3 7h11v10H3V7z" stroke="currentColor" strokeWidth="2" />
      <path d="M14 10h4l3 3v4h-7v-7z" stroke="currentColor" strokeWidth="2" />
      <path d="M7 19a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" stroke="currentColor" strokeWidth="2" />
      <path d="M18 19a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" stroke="currentColor" strokeWidth="2" />
    </IconBase>
  );
}

function IconClipboard(props: any) {
  return (
    <IconBase {...props}>
      <path d="M9 4h6v2H9V4z" stroke="currentColor" strokeWidth="2" />
      <path d="M7 6h10v14H7V6z" stroke="currentColor" strokeWidth="2" />
      <path d="M9 10h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M9 14h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </IconBase>
  );
}

function IconAlert(props: any) {
  return (
    <IconBase {...props}>
      <path d="M12 3l10 18H2L12 3z" stroke="currentColor" strokeWidth="2" />
      <path d="M12 9v5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M12 17h.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" />
    </IconBase>
  );
}

/* ----------------- APP SHELL ----------------- */

function AppShell() {
  return (
    <div className="app-shell">
      <Sidebar />
      <div className="app-main">

  <TopBar />
  <main className="app-main-content">
          <Routes>
            <Route path="/" element={<DashboardPage />} />

            <Route path="/orders" element={<OrdersPage />} />
            <Route path="/orders/new" element={<NewOrderPage />} />
            <Route path="/orders/:groupKey" element={<OrderDetailPage />} />
            <Route path="/tasks/new" element={<NewTaskPage />} />

            <Route path="/tasks" element={<TasksPage />} />

            <Route path="/calendar" element={<CalendarPage />} />
            <Route path="/varieties" element={<Varieties />} />
            <Route path="/login" element={<LoginPage />} />
 


            {/* ✅ This now ALWAYS uses src/pages/CustomersPage.tsx */}
            <Route path="/customers" element={<CustomersPage />} />

            <Route path="/production-sheet" element={<ProductionSheetPage />} />
            <Route path="/settings" element={<SettingsPage />} />
          </Routes>
        </main>
      </div>
    </div>
  );
}

export default function App() {
  useEffect(() => {
    supabase.auth.getUser().then(({ data }) => {
      console.log("CURRENT USER:", data.user);
    });
  }, []);

  return (
    <BrowserRouter>
      <AppShell />
    </BrowserRouter>
  );
}

/* ----------------- Shared styles ----------------- */

const labelStyle: CSSProperties = {
  display: "block",
  marginBottom: "0.25rem",
  fontSize: 14,
};

const miniLabel: CSSProperties = {
  fontSize: 12,
  color: "#64748b",
  marginBottom: 6,
};

const controlStyle: CSSProperties = {
  width: "100%",
  padding: "0.45rem 0.6rem",
  borderRadius: 8,
  border: "1px solid #cbd5f5",
  fontSize: 14,
  background: "#ffffff",
};

const primaryBtn: CSSProperties = {
  padding: "0.45rem 1.1rem",
  borderRadius: 999,
  border: "none",
  background: "#047857",
  color: "white",
  fontSize: 14,
  cursor: "pointer",
};

const secondaryBtn: CSSProperties = {
  padding: "0.45rem 1.1rem",
  borderRadius: 999,
  border: "1px solid #cbd5f5",
  background: "#ffffff",
  color: "#0f172a",
  fontSize: 14,
  cursor: "pointer",
};
